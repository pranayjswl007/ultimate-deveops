name: Release Validation in Prod

# on:
#   workflow_dispatch:
#     inputs:
#       deployFromBranch:
#         description: 'Compare with'     
#         required: true
#         type: text
#       testLevel:
#         description: 'Test Level'     
#         required: true
#         default: 'RunSpecifiedTests' 
#         type: choice
#         options:
#         - RunSpecifiedTests
#         - RunLocalTests 
#       testMethods:
#         description: 'Specify Apex Test Class Names (comma separated)'     
#         required: false
#         type: text
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  validate-build:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: 'Checkout source code'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set Environment Variables
        run: |
              echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
              echo "GITHUB_REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV
              echo "TOKEN_GITHUB=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV
              echo "COMMIT_ID=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV

      - name: 'Install Salesforce CLI'
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sf/channels/stable/sf-linux-x64.tar.xz
          mkdir ~/sf
          tar xJf sf-linux-x64.tar.xz -C ~/sf --strip-components 1
          echo "$HOME/sf/bin" >> $GITHUB_PATH
          ~/sf/bin/sf version

      - name: 'Installing sfdx git delta'
        run: |
          echo y | sf plugins install sfdx-git-delta

      - name: 'Create delta packages for new, modified or deleted metadata'
        run: |
          mkdir changed-sources
          sf sgd source delta \
            --to "HEAD" \
            --from "origin/${{ github.event.inputs.deployFromBranch || 'main' }}" \
            --output-dir changed-sources/ \
            --generate-delta \
            --source-dir force-app/

      - name: 'Zip delta package'
        run: |
          zip -r delta-package.zip changed-sources

      - name: 'Upload delta package as artifact'
        uses: actions/upload-artifact@v4
        with:
          name: delta-package
          path: delta-package.zip

      - name: 'Authenticate using SFDX_AUTH_URL'
        run: | 
          echo ${{ secrets.SF_AUTH_URL }} | sf org login sfdx-url --sfdx-url-stdin -d -s
     

      - name: 'Validate only deployment - run all tests'
        run: |
               sf project deploy start \
                --manifest "changed-sources/package/package.xml" \
                --test-level RunLocalTests \
                --dry-run \
                --pre-destructive-changes "changed-sources/destructiveChanges/package.xml" \
                --ignore-warnings \
                --json > deploymentResult.json || true 
  
      - name: "Update the PR body with the latest content to allow quick validation and summary"
        run: |
              python3 devops/prUpdated.py 
         
         